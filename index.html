<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>♟ Royal Chess - Online Schach</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Reset und Basisstile */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  color: #ecf0f1;
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1600px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 800px 1fr;
  gap: 20px;
}

/* Header */
header {
  grid-column: 1 / -1;
  text-align: center;
  margin-bottom: 30px;
  padding: 25px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 20px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

h1 {
  color: #ecf0f1;
  font-size: 3rem;
  margin-bottom: 10px;
}

.subtitle {
  color: #95a5a6;
  font-size: 1.3rem;
}

/* Schachbrett */
.board-container {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 20px;
  padding: 30px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  flex-direction: column;
  align-items: center;
}

#board {
  display: grid;
  grid-template-columns: repeat(8, 70px);
  grid-template-rows: repeat(8, 70px);
  margin: 0 auto;
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
  border-radius: 10px;
  overflow: hidden;
  border: 3px solid rgba(255, 255, 255, 0.1);
}

.square {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
  cursor: pointer;
  user-select: none;
  transition: all 0.3s ease;
}

.square.light {
  background-color: #f0d9b5;
}

.square.dark {
  background-color: #b58863;
}

.square.selected {
  background-color: rgba(231, 76, 60, 0.8) !important;
}

.piece {
  cursor: pointer;
  transition: transform 0.2s;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

/* Spielinfo */
.game-info {
  display: flex;
  justify-content: space-between;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 20px;
  padding: 20px;
  margin-top: 20px;
}

.player-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  flex: 1;
}

.player-name {
  font-size: 1.2rem;
  font-weight: bold;
}

.player-timer {
  font-size: 2rem;
  font-family: 'Courier New', monospace;
  font-weight: bold;
  color: #e74c3c;
}

/* Rechte Spalte */
.right-column {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* Lobby Bereich */
.lobby-section {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 20px;
  padding: 25px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.controls {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.input-group {
  display: flex;
  gap: 10px;
}

input {
  padding: 12px 15px;
  border: none;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
  font-size: 1rem;
  flex: 1;
}

input:focus {
  outline: none;
  border: 2px solid #3498db;
}

button {
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  background: #3498db;
  color: white;
  font-size: 1rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

button:hover {
  background: #2980b9;
  transform: translateY(-2px);
}

button:disabled {
  background: #7f8c8d;
  cursor: not-allowed;
}

/* Chat Bereich */
.chat-section {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 20px;
  padding: 25px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  flex: 1;
  display: flex;
  flex-direction: column;
}

#chat {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 10px;
  margin-bottom: 15px;
}

.message {
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.07);
}

/* Notifications */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  background: #27ae60;
  color: white;
  border-radius: 10px;
  z-index: 10000;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Responsive */
@media (max-width: 1200px) {
  .container {
    grid-template-columns: 1fr;
  }
  
  #board {
    grid-template-columns: repeat(8, minmax(50px, 60px));
    grid-template-rows: repeat(8, minmax(50px, 60px));
  }
  
  .square {
    font-size: 2.2rem;
  }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1><i class="fas fa-chess-king"></i> Royal Chess</h1>
    <p class="subtitle">Online Schach spielen - Einfach und kostenlos</p>
  </header>
  
  <main>
    <div class="board-container">
      <div id="board"></div>
      <div class="game-info">
        <div class="player-info" id="white-player">
          <div class="player-name">Weiß: <span id="white-name">Nicht verbunden</span></div>
          <div class="player-timer" id="white-timer">10:00</div>
        </div>
        
        <div style="display: flex; align-items: center; justify-content: center; padding: 0 20px;">
          <div id="game-status" style="color: #3498db; font-weight: bold;"></div>
        </div>
        
        <div class="player-info" id="black-player">
          <div class="player-name">Schwarz: <span id="black-name">Nicht verbunden</span></div>
          <div class="player-timer" id="black-timer">10:00</div>
        </div>
      </div>
    </div>
  </main>
  
  <aside class="right-column">
    <div class="lobby-section">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-door-open"></i> Lobby</h2>
      
      <div class="controls">
        <div class="input-group">
          <input type="text" id="username" placeholder="Dein Name" value="Spieler" required>
        </div>
        
        <div class="input-group">
          <input type="text" id="lobby-name" placeholder="Lobby Name (optional)">
          <button onclick="createLobby()" id="create-btn">
            <i class="fas fa-plus"></i> Erstellen
          </button>
        </div>
        
        <div class="input-group">
          <button onclick="joinRandomLobby()" id="random-btn">
            <i class="fas fa-random"></i> Schnellstart
          </button>
          <button onclick="leaveGame()" id="leave-btn" disabled style="background: #e74c3c;">
            <i class="fas fa-sign-out-alt"></i> Verlassen
          </button>
        </div>
      </div>
      
      <div style="margin-top: 20px;">
        <h3 style="margin-bottom: 15px;"><i class="fas fa-list"></i> Verfügbare Lobbys</h3>
        <div id="lobbies" style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px;">
          <div style="text-align: center; color: #95a5a6; padding: 20px;">
            Lade Lobbys...
          </div>
        </div>
      </div>
    </div>
    
    <div class="chat-section">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-comments"></i> Chat</h2>
      <div id="chat">
        <div class="message" style="background: rgba(52, 152, 219, 0.1);">
          <strong>System:</strong> Willkommen! Erstelle eine Lobby oder trete einer bei.
        </div>
      </div>
      <div class="input-group">
        <input type="text" id="message" placeholder="Nachricht eingeben..." onkeypress="if(event.key === 'Enter') sendMessage()">
        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>
<script type="module">
// Debugging aktivieren
console.log("Script wird geladen...");

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get, update, push, onValue, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase Konfiguration - DEINE ECHTEN DATEN
const firebaseConfig = {
  apiKey: "AIzaSyCEAG-c_hJV5SydzleMsTmid8CDmRSa9Y0",
  authDomain: "online-chess-c5083.firebaseapp.com",
  databaseURL: "https://online-chess-c5083-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "online-chess-c5083",
  storageBucket: "online-chess-c5083.firebasestorage.app",
  messagingSenderId: "851749075446",
  appId: "1:851749075446:web:094a7321aeae337c08afd7"
};

console.log("Initialisiere Firebase...");
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
console.log("Firebase initialisiert:", db);

// Test Firebase-Verbindung
const testRef = ref(db, 'test');
set(testRef, { timestamp: Date.now() }).then(() => {
  console.log("Firebase-Verbindung erfolgreich!");
  showNotification("Mit Firebase verbunden", "success");
}).catch(error => {
  console.error("Firebase-Fehler:", error);
  showNotification("Fehler bei Firebase-Verbindung", "error");
});

// Globale Variablen
let game = new Chess();
let gameRef = null;
let lobbyRef = null;
let selectedSquare = null;
let playerRole = null;
let playerName = "Spieler";
let lobbyId = null;
let gameId = null;
let playerId = Math.random().toString(36).substring(2, 15);
let timers = { white: 600, black: 600 };
let timerInterval = null;

// Unicode Schachfiguren
const pieceSymbols = {
  'p': '♟', 'n': '♞', 'b': '♝', 'r': '♜', 'q': '♛', 'k': '♚',
  'P': '♙', 'N': '♘', 'B': '♗', 'R': '♖', 'Q': '♕', 'K': '♔'
};

// Initialisiere das Spielbrett
function initializeBoard() {
  console.log("Initialisiere Board...");
  const boardElement = document.getElementById('board');
  boardElement.innerHTML = '';
  
  for (let row = 0; row < 8; row++) {
    for (let col = 0; col < 8; col++) {
      const square = document.createElement('div');
      const squareId = `${String.fromCharCode(97 + col)}${8 - row}`;
      
      square.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
      square.dataset.square = squareId;
      square.onclick = () => handleSquareClick(squareId);
      boardElement.appendChild(square);
    }
  }
  updateBoard();
}

// Aktualisiere das Brett
function updateBoard() {
  const board = game.board();
  const squares = document.querySelectorAll('.square');
  
  squares.forEach(square => {
    square.innerHTML = '';
    square.classList.remove('selected');
  });
  
  for (let row = 0; row < 8; row++) {
    for (let col = 0; col < 8; col++) {
      const piece = board[row][col];
      if (piece) {
        const squareIndex = row * 8 + col;
        const square = squares[squareIndex];
        const symbol = pieceSymbols[piece.type];
        
        square.innerHTML = `<div class="piece">${symbol}</div>`;
      }
    }
  }
  
  if (selectedSquare) {
    const selectedElement = document.querySelector(`[data-square="${selectedSquare}"]`);
    if (selectedElement) selectedElement.classList.add('selected');
  }
  
  updateGameInfo();
}

// Handle Klick auf Feld
function handleSquareClick(squareId) {
  console.log("Klick auf:", squareId);
  
  if (!playerRole) {
    showNotification("Du bist noch nicht in einem Spiel!", "error");
    return;
  }
  
  const piece = game.get(squareId);
  
  if (!selectedSquare) {
    // Figur auswählen
    if (piece) {
      // Prüfe ob Spieler die Figur besitzt
      const isWhite = piece.color === 'w';
      const ownsPiece = (isWhite && playerRole === 'white') || (!isWhite && playerRole === 'black');
      
      if (ownsPiece) {
        selectedSquare = squareId;
        updateBoard();
      }
    }
  } else {
    // Zug versuchen
    try {
      const move = game.move({
        from: selectedSquare,
        to: squareId,
        promotion: 'q'
      });
      
      console.log("Zug ausgeführt:", move);
      selectedSquare = null;
      updateBoard();
      
      // In Firebase speichern
      if (gameRef) {
        update(gameRef, {
          fen: game.fen(),
          turn: game.turn(),
          lastMove: { from: move.from, to: move.to }
        }).then(() => {
          console.log("Spiel aktualisiert");
        }).catch(error => {
          console.error("Fehler beim Update:", error);
        });
      }
      
      checkGameStatus();
      
    } catch (error) {
      console.log("Ungültiger Zug:", error);
      selectedSquare = null;
      updateBoard();
    }
  }
}

// Lobby erstellen
window.createLobby = async function() {
  try {
    console.log("Erstelle Lobby...");
    
    playerName = document.getElementById('username').value.trim() || 'Spieler';
    const lobbyName = document.getElementById('lobby-name').value.trim() || `${playerName}'s Lobby`;
    
    if (!playerName) {
      showNotification("Bitte gib einen Namen ein!", "error");
      return;
    }
    
    // Erstelle eindeutige ID
    lobbyId = 'lobby_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
    lobbyRef = ref(db, `lobbies/${lobbyId}`);
    
    console.log("Lobby ID:", lobbyId);
    
    // Lobby in Firebase erstellen
    await set(lobbyRef, {
      name: lobbyName,
      host: playerName,
      hostId: playerId,
      players: { white: playerId },
      status: 'waiting',
      createdAt: Date.now(),
      timeControl: '600'
    });
    
    console.log("Lobby erstellt");
    
    // Spieler als Weiß setzen
    playerRole = 'white';
    
    // Spiel in Firebase erstellen
    gameId = lobbyId;
    gameRef = ref(db, `games/${gameId}`);
    
    await set(gameRef, {
      fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
      turn: 'w',
      status: 'waiting',
      players: { white: playerId, black: null },
      playerNames: { white: playerName, black: null },
      createdAt: Date.now()
    });
    
    console.log("Spiel erstellt");
    
    // UI aktualisieren
    document.getElementById('create-btn').disabled = true;
    document.getElementById('random-btn').disabled = true;
    document.getElementById('leave-btn').disabled = false;
    
    showNotification(`Lobby "${lobbyName}" erstellt!`, "success");
    addChatMessage("System", `Lobby "${lobbyName}" erstellt. Warte auf Gegner...`);
    
    // Spiel starten
    startGame();
    
  } catch (error) {
    console.error("Fehler beim Erstellen der Lobby:", error);
    showNotification("Fehler beim Erstellen der Lobby", "error");
  }
};

// Zufällige Lobby beitreten
window.joinRandomLobby = async function() {
  try {
    console.log("Suche zufällige Lobby...");
    
    playerName = document.getElementById('username').value.trim() || 'Spieler';
    
    const lobbiesRef = ref(db, 'lobbies');
    const snapshot = await get(lobbiesRef);
    
    if (snapshot.exists()) {
      const lobbies = snapshot.val();
      const availableLobbies = Object.entries(lobbies)
        .filter(([id, lobby]) => lobby.status === 'waiting')
        .map(([id, lobby]) => ({ id, ...lobby }));
      
      if (availableLobbies.length > 0) {
        const randomLobby = availableLobbies[Math.floor(Math.random() * availableLobbies.length)];
        
        console.log("Beitrete Lobby:", randomLobby.id);
        await joinSpecificLobby(randomLobby.id);
        
      } else {
        showNotification("Keine verfügbaren Lobbys gefunden", "warning");
      }
    } else {
      showNotification("Keine Lobbys verfügbar", "warning");
    }
  } catch (error) {
    console.error("Fehler beim Beitritt:", error);
    showNotification("Fehler beim Beitritt", "error");
  }
};

// Bestimmte Lobby beitreten
async function joinSpecificLobby(id) {
  try {
    lobbyId = id;
    lobbyRef = ref(db, `lobbies/${lobbyId}`);
    
    const lobbySnapshot = await get(lobbyRef);
    if (!lobbySnapshot.exists()) {
      showNotification("Lobby existiert nicht mehr", "error");
      return;
    }
    
    const lobby = lobbySnapshot.val();
    
    // Prüfe welche Farbe verfügbar ist
    if (!lobby.players.white) {
      playerRole = 'white';
      await update(lobbyRef, {
        'players/white': playerId,
        status: 'playing'
      });
    } else if (!lobby.players.black) {
      playerRole = 'black';
      await update(lobbyRef, {
        'players/black': playerId,
        status: 'playing'
      });
    } else {
      showNotification("Lobby ist bereits voll!", "error");
      return;
    }
    
    // Spiel beitreten
    gameId = lobbyId;
    gameRef = ref(db, `games/${gameId}`);
    
    await update(gameRef, {
      [`players/${playerRole}`]: playerId,
      [`playerNames/${playerRole}`]: playerName,
      status: 'active'
    });
    
    // UI aktualisieren
    document.getElementById('create-btn').disabled = true;
    document.getElementById('random-btn').disabled = true;
    document.getElementById('leave-btn').disabled = false;
    
    showNotification(`Beigetreten zu "${lobby.name}"`, "success");
    
    // Spiel starten
    startGame();
    
    addChatMessage("System", `${playerName} ist dem Spiel beigetreten!`);
    
  } catch (error) {
    console.error("Fehler beim Beitritt:", error);
    showNotification("Fehler beim Beitritt", "error");
  }
}

// Spiel starten
function startGame() {
  console.log("Starte Spiel...");
  
  // Listener für Spielupdates
  onValue(gameRef, (snapshot) => {
    if (snapshot.exists()) {
      const gameData = snapshot.val();
      console.log("Spielupdate:", gameData);
      
      // Lade Spielposition
      if (gameData.fen && gameData.fen !== game.fen()) {
        game.load(gameData.fen);
        updateBoard();
      }
      
      // Aktualisiere Spielernamen
      if (gameData.playerNames) {
        document.getElementById('white-name').textContent = gameData.playerNames.white || 'Warten...';
        document.getElementById('black-name').textContent = gameData.playerNames.black || 'Warten...';
      }
      
      // Aktiviere/Deaktiviere je nach Zugrecht
      const isMyTurn = (game.turn() === 'w' && playerRole === 'white') || 
                       (game.turn() === 'b' && playerRole === 'black');
      
      document.getElementById('game-status').textContent = isMyTurn ? 'Du bist am Zug' : 'Gegner am Zug';
    }
  });
  
  // Listener für Chat
  const chatRef = ref(db, `games/${gameId}/chat`);
  onChildAdded(chatRef, (snapshot) => {
    const message = snapshot.val();
    if (message && message.sender !== playerId) {
      addChatMessage(message.senderName, message.text);
    }
  });
  
  // Timer starten
  startTimers();
}

// Timer starten
function startTimers() {
  if (timerInterval) clearInterval(timerInterval);
  
  timerInterval = setInterval(() => {
    if (game.turn() === 'w') {
      timers.white = Math.max(0, timers.white - 1);
      document.getElementById('white-timer').textContent = formatTime(timers.white);
    } else {
      timers.black = Math.max(0, timers.black - 1);
      document.getElementById('black-timer').textContent = formatTime(timers.black);
    }
    
    // Zeitüberschreitung
    if (timers.white <= 0 || timers.black <= 0) {
      endGame('time');
    }
  }, 1000);
}

// Formatiere Zeit
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Lade Lobbys
function loadLobbies() {
  console.log("Lade Lobbys...");
  const lobbiesRef = ref(db, 'lobbies');
  
  onValue(lobbiesRef, (snapshot) => {
    const lobbiesContainer = document.getElementById('lobbies');
    
    if (snapshot.exists()) {
      const lobbies = snapshot.val();
      const lobbyArray = Object.entries(lobbies)
        .filter(([id, lobby]) => lobby.status === 'waiting')
        .slice(0, 5); // Nur 5 Lobbys anzeigen
      
      if (lobbyArray.length === 0) {
        lobbiesContainer.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #95a5a6;">
            Keine offenen Lobbys verfügbar
          </div>
        `;
      } else {
        lobbiesContainer.innerHTML = '';
        lobbyArray.forEach(([id, lobby]) => {
          const lobbyElement = document.createElement('div');
          lobbyElement.style.cssText = `
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
          `;
          lobbyElement.onclick = () => joinSpecificLobby(id);
          
          lobbyElement.innerHTML = `
            <div>
              <div style="font-weight: bold;">${lobby.name}</div>
              <div style="font-size: 0.9rem; color: #95a5a6;">Host: ${lobby.host}</div>
            </div>
            <div>
              <span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;">
                ${lobby.players.white ? '1/2' : '0/2'}
              </span>
            </div>
          `;
          lobbiesContainer.appendChild(lobbyElement);
        });
      }
    } else {
      lobbiesContainer.innerHTML = `
        <div style="text-align: center; padding: 20px; color: #95a5a6;">
          Keine Lobbys verfügbar
        </div>
      `;
    }
  });
}

// Lobby verlassen
window.leaveGame = async function() {
  if (!lobbyId) return;
  
  try {
    if (lobbyRef) {
      const lobbySnapshot = await get(lobbyRef);
      if (lobbySnapshot.exists()) {
        const lobby = lobbySnapshot.val();
        
        if (lobby.hostId === playerId) {
          // Host verlässt - Lobby löschen
          await remove(lobbyRef);
          if (gameRef) await remove(gameRef);
          showNotification('Lobby gelöscht', 'info');
        } else {
          // Spieler entfernen
          await update(lobbyRef, {
            [`players/${playerRole}`]: null,
            status: 'waiting'
          });
          
          if (gameRef) {
            await update(ref(db, `games/${gameId}/players`), {
              [playerRole]: null
            });
            
            addChatMessage('System', `${playerName} hat das Spiel verlassen.`);
          }
        }
      }
    }
    
    resetGame();
    showNotification('Lobby verlassen', 'info');
    
  } catch (error) {
    console.error('Fehler beim Verlassen:', error);
    showNotification('Fehler beim Verlassen', 'error');
  }
};

// Spiel zurücksetzen
function resetGame() {
  game = new Chess();
  gameRef = null;
  lobbyRef = null;
  selectedSquare = null;
  playerRole = null;
  lobbyId = null;
  gameId = null;
  timers = { white: 600, black: 600 };
  
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  
  document.getElementById('create-btn').disabled = false;
  document.getElementById('random-btn').disabled = false;
  document.getElementById('leave-btn').disabled = true;
  
  document.getElementById('white-name').textContent = 'Nicht verbunden';
  document.getElementById('black-name').textContent = 'Nicht verbunden';
  document.getElementById('white-timer').textContent = '10:00';
  document.getElementById('black-timer').textContent = '10:00';
  document.getElementById('game-status').textContent = '';
  
  updateBoard();
}

// Chat
window.sendMessage = async function() {
  const messageInput = document.getElementById('message');
  const text = messageInput.value.trim();
  
  if (!text || !gameId || text.length === 0) return;
  
  try {
    const chatRef = ref(db, `games/${gameId}/chat`);
    await push(chatRef, {
      text: text,
      sender: playerId,
      senderName: playerName,
      timestamp: Date.now()
    });
    
    // Lokal hinzufügen
    addChatMessage(playerName, text);
    
    messageInput.value = '';
    messageInput.focus();
  } catch (error) {
    console.error('Fehler beim Senden:', error);
  }
};

function addChatMessage(sender, text) {
  const chatContainer = document.getElementById('chat');
  const messageElement = document.createElement('div');
  messageElement.className = 'message';
  messageElement.innerHTML = `<strong>${sender}:</strong> ${text}`;
  chatContainer.appendChild(messageElement);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Spielstatus prüfen
function checkGameStatus() {
  const statusElement = document.getElementById('game-status');
  
  if (game.isCheckmate()) {
    const winner = game.turn() === 'w' ? 'Schwarz' : 'Weiß';
    statusElement.textContent = `Schachmatt! ${winner} gewinnt!`;
    endGame('checkmate', winner);
  } else if (game.isDraw()) {
    statusElement.textContent = 'Remis!';
    endGame('draw');
  } else if (game.in_check()) {
    statusElement.textContent = 'Schach!';
  }
}

function endGame(reason, winner = null) {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  
  let message = '';
  switch(reason) {
    case 'checkmate':
      message = `${winner} hat gewonnen!`;
      break;
    case 'draw':
      message = 'Das Spiel endet unentschieden.';
      break;
    case 'time':
      const loser = game.turn() === 'w' ? 'Weiß' : 'Schwarz';
      const timeWinner = loser === 'Weiß' ? 'Schwarz' : 'Weiß';
      message = `${loser} hat die Zeit überschritten. ${timeWinner} gewinnt!`;
      break;
  }
  
  showNotification(message, 'info');
  addChatMessage('System', `Spiel beendet: ${message}`);
}

// Notification anzeigen
function showNotification(message, type = 'info') {
  console.log("Notification:", message);
  
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.textContent = message;
  
  if (type === 'error') {
    notification.style.background = '#e74c3c';
  } else if (type === 'warning') {
    notification.style.background = '#f39c12';
  } else if (type === 'success') {
    notification.style.background = '#27ae60';
  }
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

function updateGameInfo() {
  // Hier kannst du zusätzliche Spielinfos aktualisieren
}

// Initialisiere das Spiel
initializeBoard();
loadLobbies();

// Debug-Info
console.log("Spiel initialisiert. Player ID:", playerId);
showNotification("Spiel bereit! Erstelle eine Lobby oder trete einer bei.", "success");
</script>
</body>
</html>
