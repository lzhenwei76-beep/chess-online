<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Online Schach</title>

<style>
body {
  background:#111;
  color:white;
  font-family:Arial;
  display:flex;
  gap:20px;
  padding:20px;
}

#left { }
#right { width:250px; }

#board {
  display:grid;
  grid-template-columns:repeat(8,60px);
}

.square {
  width:60px;
  height:60px;
  font-size:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

.white { background:#eee; color:black; }
.black { background:#555; }
.selected { outline:3px solid red; }

#chat {
  height:360px;
  overflow-y:auto;
  border:1px solid #444;
  padding:5px;
  margin-bottom:5px;
}

input, button {
  width:100%;
  margin-top:5px;
}
</style>
</head>

<body>

<div id="left">
  <h2>â™Ÿ Online Schach</h2>
  <input id="gameId" placeholder="Game ID">
  <button onclick="joinGame()">Beitreten / Erstellen</button>
  <p id="role"></p>
  <div id="board"></div>
</div>

<div id="right">
  <h3>ðŸ’¬ Chat</h3>
  <div id="chat"></div>
  <input id="msg" placeholder="Nachricht">
  <button onclick="sendMsg()">Senden</button>
</div>

<!-- chess.js (Regeln) -->
<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get, update, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCEAG-c_hJV5SydzleMsTmid8CDmRSa9Y0",
  authDomain: "online-chess-c5083.firebaseapp.com",
  databaseURL: "https://online-chess-c5083-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "online-chess-c5083",
  storageBucket: "online-chess-c5083.firebasestorage.app",
  messagingSenderId: "851749075446",
  appId: "1:851749075446:web:094a7321aeae337c08afd7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* GAME */
let gameId, role, chess = new Chess(), selected = null;
let uid = Math.random().toString(36).slice(2);

const pieces = {
  p:"â™Ÿ", r:"â™œ", n:"â™ž", b:"â™", q:"â™›", k:"â™š",
  P:"â™™", R:"â™–", N:"â™˜", B:"â™—", Q:"â™•", K:"â™”"
};

function drawBoard() {
  const b = document.getElementById("board");
  b.innerHTML = "";
  const board = chess.board().flat();
  board.forEach((sq,i)=>{
    const d = document.createElement("div");
    d.className = "square "+((Math.floor(i/8)+i)%2?"black":"white");
    if (sq) d.textContent = pieces[sq.color === "w" ? sq.type.toUpperCase() : sq.type];
    d.onclick = ()=>clickSquare(i);
    b.appendChild(d);
  });
}

function clickSquare(i) {
  const file = "abcdefgh"[i%8];
  const rank = 8-Math.floor(i/8);
  const square = file+rank;

  if (!selected) {
    const piece = chess.get(square);
    if (!piece) return;
    if ((piece.color==="w" && role!=="white") || (piece.color==="b" && role!=="black")) return;
    selected = square;
  } else {
    const move = chess.move({from:selected,to:square});
    selected = null;
    if (move) {
      update(ref(db,"games/"+gameId),{ fen: chess.fen() });
    }
  }
  drawBoard();
}

/* JOIN GAME */
window.joinGame = async function() {
  gameId = document.getElementById("gameId").value || Math.random().toString(36).slice(2,7);
  document.getElementById("gameId").value = gameId;

  const gameRef = ref(db,"games/"+gameId);
  const snap = await get(gameRef);

  if (!snap.exists()) {
    role="white";
    set(gameRef,{
      fen: chess.fen(),
      players:{ white:uid }
    });
  } else {
    const data = snap.val();
    if (!data.players.black) {
      role="black";
      update(gameRef,{ "players/black":uid });
    } else {
      alert("Spiel voll");
      return;
    }
  }

  document.getElementById("role").textContent="Du bist: "+role;

  onValue(gameRef,s=>{
    chess.load(s.val().fen);
    drawBoard();
  });

  onValue(ref(db,"games/"+gameId+"/chat"),snap=>{
    const c=document.getElementById("chat");
    c.innerHTML="";
    snap.forEach(m=>{
      const p=document.createElement("div");
      p.textContent=m.val().text;
      c.appendChild(p);
    });
    c.scrollTop=9999;
  });
};

/* CHAT */
window.sendMsg = function() {
  const text=document.getElementById("msg").value;
  if (!text) return;
  push(ref(db,"games/"+gameId+"/chat"),{ text });
  document.getElementById("msg").value="";
};

drawBoard();
</script>

</body>
</html>
